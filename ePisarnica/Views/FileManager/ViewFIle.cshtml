@model ePisarnica.Models.Document

@{
    ViewData["Title"] = Model.Title;
}

<div class="container-fluid my-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
        <h4 class="fw-bold text-primary">
            <i class="bi bi-file-earmark-text me-2"></i>@Model.Title@Model.FileExtension
        </h4>
        <div class="d-flex flex-wrap gap-2 w-100 w-md-auto">
            <a asp-action="DownloadFile" asp-route-id="@Model.Id" class="btn btn-primary flex-fill flex-md-grow-0">
                <i class="bi bi-download"></i> Preuzmi
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary flex-fill flex-md-grow-0">
                <i class="bi bi-arrow-left"></i> Nazad
            </a>
        </div>
    </div>

    <div class="card shadow-sm rounded-4 border-0">
        <div class="card-header bg-light border-0 rounded-top-4">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active fw-semibold" data-bs-toggle="tab" href="#preview">
                        <i class="bi bi-eye"></i> Pregled
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-semibold" data-bs-toggle="tab" href="#details">
                        <i class="bi bi-info-circle"></i> Detalji
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body p-4">
            <div class="tab-content">
                <!-- PREVIEW -->
                <div class="tab-pane fade show active" id="preview">
                    @if (Model.FileType == FileType.Image)
                    {
                        <div class="text-center">
                            <img src="@Url.Action("OpenFile", new { id = Model.Id })"
                                 class="img-fluid rounded shadow-sm"
                                 alt="@Model.Title"
                                 style="max-height: 70vh;">
                        </div>
                    }
                    else if (Model.FileType == FileType.Document)
                    {
                        <div class="alert alert-info text-center py-5 rounded-3">
                            <i class="bi bi-file-earmark-text fs-1 text-primary mb-2"></i>
                            <h5>Pregled dokumenta nije dostupan</h5>
                            <p class="mb-3">Ovaj dokument se ne može otvoriti direktno u pregledniku.</p>
                            <a href="@Url.Action("OpenFile", new { id = Model.Id })"
                               target="_blank"
                               class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> Otvori u novom prozoru
                            </a>
                        </div>
                    }
                    else if (Model.FileType == FileType.Audio)
                    {
                        <div class="text-center">
                            <audio controls class="w-100 rounded shadow-sm">
                                <source src="@Url.Action("OpenFile", new { id = Model.Id })" type="@GetMimeType(Model.FileExtension)">
                                Vaš preglednik ne podržava audio element.
                            </audio>
                        </div>
                    }
                    else if (Model.FileType == FileType.Video)
                    {
                        <div class="text-center">
                            <video controls class="w-100 rounded shadow-sm" style="max-height: 70vh;">
                                <source src="@Url.Action("OpenFile", new { id = Model.Id })" type="@GetMimeType(Model.FileExtension)">
                                Vaš preglednik ne podržava video element.
                            </video>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center py-5 rounded-3">
                            <i class="bi bi-file-earmark fs-1 mb-2"></i>
                            <h5>Pregled fajla nije dostupan</h5>
                            <p class="mb-3">Ovaj tip fajla se ne može pregledati u pregledniku.</p>
                            <a href="@Url.Action("DownloadFile", new { id = Model.Id })"
                               class="btn btn-primary">
                                <i class="bi bi-download"></i> Preuzmi fajl
                            </a>
                        </div>
                    }
                </div>

                <!-- DETAILS -->
                <div class="tab-pane fade" id="details">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <table class="table table-striped table-hover">
                                <tr>
                                    <th>Naziv fajla:</th>
                                    <td>@Model.Title@Model.FileExtension</td>
                                </tr>
                                <tr>
                                    <th>Veličina fajla:</th>
                                    <td><span class="badge bg-info text-dark">@FormatFileSize(Model.FileSize)</span></td>
                                </tr>
                                <tr>
                                    <th>Tip fajla:</th>
                                    <td><span class="badge bg-secondary">@Model.FileType</span></td>
                                </tr>
                                <tr>
                                    <th>Dodano:</th>
                                    <td>@Model.CreatedAt.ToString("f")</td>
                                </tr>
                                <tr>
                                    <th>Zadnja izmjena:</th>
                                    <td>@Model.ModifiedAt.ToString("f")</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Akcije</h6>
                            <div class="d-grid gap-2">
                                <a asp-action="DownloadFile" asp-route-id="@Model.Id" class="btn btn-primary">
                                    <i class="bi bi-download"></i> Preuzmi
                                </a>
                                <a href="@Url.Action("OpenFile", new { id = Model.Id })"
                                   target="_blank"
                                   class="btn btn-outline-primary">
                                    <i class="bi bi-box-arrow-up-right"></i> Otvori u novom prozoru
                                </a>
                                @if (User.IsInRole("Admin"))
                                {
                                    <button class="btn btn-outline-danger" onclick="moveToTrash(@Model.Id)">
                                        <i class="bi bi-trash"></i> Premjesti u smeće
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function moveToTrash(fileId) {
            if (confirm('Da li ste sigurni da želite premjestiti ovaj fajl u smeće?')) {
                fetch('@Url.Action("MoveToTrash", "FileManager")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: fileId })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        window.location.href = '@Url.Action("Index")';
                    } else {
                        alert('Neuspješno premještanje u smeće: ' + result.message);
                    }
                })
                .catch(error => {
                    alert('Greška prilikom premještanja u smeće: ' + error.message);
                });
            }
        }
    </script>
}


@functions {
    private string GetMimeType(string fileExtension)
    {
        return fileExtension.ToLower() switch
        {
            ".pdf" => "application/pdf",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".xls" => "application/vnd.ms-excel",
            ".xlsx" => "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ".jpg" or ".jpeg" => "image/jpeg",
            ".png" => "image/png",
            ".gif" => "image/gif",
            ".mp3" => "audio/mpeg",
            ".mp4" => "video/mp4",
            ".zip" => "application/zip",
            _ => "application/octet-stream"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double len = bytes;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
